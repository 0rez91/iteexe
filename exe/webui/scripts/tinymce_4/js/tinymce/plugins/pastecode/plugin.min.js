/**
 * plugin.min.js
 *
 * Released under Attribution-ShareAlike 4.0 International License.
 * Author: Ignacio Gros (http://gros.es/) for http://exelearning.net/
 *
 * License: http://creativecommons.org/licenses/by-sa/4.0/
 */

/**
 * Insert HTML code or HTML code as text
 * Don't forget to add some styles to theme/site so the code has the same appearance everywhere (see eXe's base.css file)
 */
tinymce.PluginManager.add('pastecode', function(editor, url) {
	
	PasteCodeDialog = {
		
		// Load the previous values (if needed)
		getValues : function(){
			var sel = editor.selection;
			var v = sel.getContent({format : 'text'});
			var node = sel.getNode();			
			
			this.initialValue = v;
			this.isCodeTag = false;
			this.isInPRE = false;
			this.isWrapped = false;	

			if (node.nodeName=="CODE"){
				this.isCodeTag = true;
				var c = node.innerHTML;
				c = c.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
				v = c;
				var wrapper = win.find('#wrapper')[0];
				// Check if it's  <pre><code></code></pre> and if it has wrapper
				var pre = node.parentNode;
				if (pre.nodeName == "PRE") {
					
					this.isInPRE = true;
					wrapper.checked(false);
					
					var block = pre.parentNode.parentNode;
					if (block.nodeName=="DIV" && block.className=="pre-code") {
						this.isWrapped = true;
						wrapper.checked(true);
					}
					
				} else {
					wrapper.checked(false);
				}				
			}
			win.find('#htmlSource')[0].value(v);
		},
		
		// Create or update the content
		insert : function(content){
			
			if (content=="") return "";
			
			var t = content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
			var c = "<pre><code>"+t+"</code></pre><br />";
			
			// Include wrapper if checked
			var wrapper = win.find('#wrapper')[0].checked();
			if (wrapper) {
				c = "<div class='pre-code'><div><pre><code>"+t+"</code></pre></div></div><br />";
			} else {
				if (this.initialValue!="") c = "<code>"+t+"</code>";
			}
			
			// Insert the content
			if (this.isCodeTag==false) {
				
				// New content
				editor.insertContent(c);
			
			} else {
				
				// Upate the selected content
				var ed = editor;
				var node = ed.selection.getNode();
				var pre = node.parentNode;
				var block = pre.parentNode.parentNode;
				
				// The  current CODE tag is inside a PRE tag
				if (this.isInPRE) {
					
					if (wrapper) {
						if (this.isWrapped) {
							// It's wrapped, so we just update the content
							node.innerHTML = t;
						} else {
							// It's a PRE tag, but not wrapped, so we wrap it
							ed.dom.remove(pre);
							ed.execCommand('mceInsertContent', false, c);
						}
					} else {
						if (this.isWrapped) {
							// It was wrapped, so we remove the wrapper and just add the new content
							ed.dom.remove(block);
							ed.execCommand('mceInsertContent', false, c);
						} else {
							// It has no wrapper, so we just update the content
							node.innerHTML = t;
						}
					}
					
				} else {
					
					// The  current CODE tag is not inside a PRE tag
					if (wrapper) {
						// It has no wrapper, so we wrap it
						ed.dom.remove(node);
						ed.execCommand('mceInsertContent', false, c);
					} else {
						// We just update the content
						node.innerHTML = t;
					}
					
				}
			}
		},
		
		open : function(){
			
			// Open the window and load the previous values
			win = editor.windowManager.open({
				title: _('Insert HTML code as text'),
				width: 500,
				height: 250,
				body: [
					{
						name: 'wrapper', 
						id: 'wrapper',
						type: 'checkbox', 
						checked: true, 
						text: _('Include wrapper (improves presentation)')
					},
					{
						type: 'label',
						text: _('Use CTRL+V on your keyboard to paste the code into the window.'),
						forId: 'htmlSource'
					},
					{
						id: 'htmlSource',
						type: 'textbox',
						name: 'htmlSource',
						minHeight: 150,
						// value: ...(),
						multiline: true
					}
				],
				onsubmit: function(e) {
					// Insert content when the window form is submitted
					PasteCodeDialog.insert(e.data.htmlSource);
				}
			});
			PasteCodeDialog.getValues();
			
		}, // open
		
		activateButton : function(node) {
			
			var nodeName = node.nodeName;
			var activate = false;
			var parentDIVs = editor.dom.getParents(node, 'div');
			
			if (nodeName=="PRE" || nodeName=="CODE") {
				if (parentDIVs.length>1) {
					for (var i=0;i<parentDIVs.length;i++) {
						if (parentDIVs[i].className.indexOf("pre-code")!=-1) activate = true;
					}
				}
			}
			
			return activate;
			
		}		
		
	} // PasteCodeDialog	
	
	editor.addButton('pastecode', {
		image: url + '/img/pastecode.gif',
		tooltip: _('Insert HTML code as text'),
		onclick: PasteCodeDialog.open,
		onPostRender: function() {
			var ctrl = this;
			editor.on('NodeChange', function(e) {
				ctrl.active(PasteCodeDialog.activateButton(e.element));
			});
		}		
	});
	
	editor.addMenuItem('pastecode', {
		// icon: 'image',
		text: _('Insert HTML code as text'),
		onclick: PasteCodeDialog.open,
		context: 'insert'
	});
	
	editor.on('init', function(e) {
		editor.dom.loadCSS(url + "/css/content.css");
	});
	
});