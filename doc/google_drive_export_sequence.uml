@startuml
'PlantUML Diagram. http://plantuml.sourceforge.net'

actor User

participant "eXe UI" as UI
participant "eXe Auth Callback" as CB
participant "eXe Engine" as E
participant "eXe Engine Deferred Thread" as D
participant "Google API" as G

activate UI
User->UI: Click on Publish to Google Drive
note right of User
click event
on #file_export_googledrive
end note

note right of UI
inmediate = TRUE
end note
UI->G: authorize()
activate G
UI<--G: authResult
note left of G
authResult.error = 'inmediate_failed'
end note
deactivate G

note right of UI
inmediate = FALSE
end note
UI->G: authorize()
deactivate UI
activate G
note over G
Authorization process:
User logins and authorizes
eXe to upload files
end note
CB<--G: authResult
deactivate G
activate CB
UI<-CB: authResult
deactivate CB
activate UI
note left of G
authResult.access_token = '<<token>>'
end note

note right of UI
access_token = authResult.access_token
user_agent = navigator.userAgent
end note
UI->E: exportGoogleDrive()
deactivate UI
activate E
note over E
exportDir = <<temp dir>>
endnote
E->E: exportWebSite()
activate UI
E->UI: googleExportProgressUpdate()
deactivate UI
note over E
endnote
E->>D: uploadPublicFolder(folderName, exportDir)
deactivate E
activate D
D->G: drive.files().insert().execute()
activate G
D<--G: fileResource
D->G: drive.permissions().insert().execute()
D<--G: permissionsResource
deactivate G
note left D
publicFolderId = fileResource.id
end note
D->E: publicFolder_onSuccess(fileResource, exportDir)
deactivate D
activate E
activate UI
E->UI: googleExportProgressUpdate()
deactivate UI
note over E
chained async calls
to uploadFile()
endnote
loop files in exportDir
  E->>D: uploadFile(pulicFolderId, file)
  deactivate E
  activate D
  D->G: drive.files.insert()
  activate G
  D<--G: fileResource
  deactivate G
  D->E: uploadfFile_onSuccess()
  deactivate D
  activate E
  activate UI
  E->UI: googleExportProgressUpdate()
  deactivate UI
end loop

E->E: deleteTempDir(exportDir)
E->UI: googleExportProgressUpdate()
deactivate E
activate UI
UI->User: Export finished
deactivate UI

@enduml